<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Supplier – Active Batches</title>

<style>
body{font-family:Arial;background:#f4f5f7;margin:0}
header{
  background:#fff;
  padding:16px 20px;
  font-size:18px;
  font-weight:600;
  border-bottom:1px solid #ddd
}

.batch{
  background:#fff;
  margin:14px;
  border-radius:10px;
  border:1px solid #ddd
}

.batch h3{
  margin:0;
  padding:12px 16px;
  background:#fafafa;
  border-bottom:1px solid #eee
}

.row{
  display:grid;
  grid-template-columns:2fr 90px 90px 90px 100px;
  padding:10px 16px;
  border-top:1px solid #eee;
  font-size:13px;
  align-items:center
}
.row.head{
  font-weight:bold;
  background:#f9f9f9
}

.buyerBox{
  background:#fafafa;
  margin:6px 16px 12px;
  border:1px solid #ddd;
  border-radius:6px
}

.buyerRow{
  display:grid;
  grid-template-columns:120px 80px 90px 90px 220px;
  padding:6px 10px;
  font-size:12px;
  border-top:1px solid #eee;
  align-items:center
}
.buyerRow.head{
  font-weight:bold;
  background:#eee
}

input.qty{
  width:60px;
  padding:4px
}

button{
  padding:4px 8px;
  background:#000;
  color:#fff;
  border:none;
  cursor:pointer;
  margin-right:4px
}
button.reject{background:#c0392b}
button[disabled]{background:#aaa;cursor:not-allowed}
</style>
</head>

<body>

<header>Supplier – Active Batches</header>
<div id="batches">Loading…</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzmemqtHqusZH8IClo9QWFM0RGks6qEzBd10aUP44XU-ImZo146DCmP1n4v1cevjFyr/exec";
const SUPPLIER_ID = localStorage.getItem("supplierId") || "SUP001";

/* ================= LOAD ================= */

function load(){
  fetch(`${API}?action=getSupplierActiveBatches&supplierId=${SUPPLIER_ID}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){
        batches.innerText=j.message||"Failed to load";
        return;
      }
      render(j.data||[]);
    });
}

load();

/* ================= RENDER ================= */

function render(data){
  const wrap = document.getElementById("batches");
  wrap.innerHTML="";

  if(!data.length){
    wrap.innerHTML="<small>No active batches</small>";
    return;
  }

  data.forEach(batch=>{
    const block=document.createElement("div");
    block.className="batch";

    block.innerHTML=`
      <h3>Batch ${batch.batchId}</h3>
      <div class="row head">
        <div>Product</div>
        <div>Batch</div>
        <div>Approved</div>
        <div>Requested</div>
        <div>Sellable</div>
      </div>
    `;

    batch.items.forEach(item=>{
      block.innerHTML+=`
        <div class="row">
          <div><b>${item.productCode}</b><br>${item.productName||""}</div>
          <div>${item.totalSets}</div>
          <div>${item.approvedSets}</div>
          <div>${item.requestedSets}</div>
          <div><b>${item.availableSets}</b></div>
        </div>
        <div id="buyers-${item.productCode}-${batch.batchId}"></div>
      `;
      loadBuyers(batch.batchId,item.productCode);
    });

    wrap.appendChild(block);
  });
}

/* ================= BUYER BREAKDOWN ================= */

function loadBuyers(batchId, productCode){
  fetch(`${API}?action=getBuyerRequestsForBatchProduct&batchId=${batchId}&productCode=${productCode}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success") return;

      const div=document.getElementById(`buyers-${productCode}-${batchId}`);
      if(!j.data.length){
        div.innerHTML="";
        return;
      }

      let h=`
        <div class="buyerBox">
          <div class="buyerRow head">
            <div>Buyer</div>
            <div>Requested</div>
            <div>Intent</div>
            <div>Approved</div>
            <div>Action</div>
          </div>
      `;

      j.data.forEach(row=>{
        const locked = row.approvedSets>0 || row.status!=="OPEN";
        const inputId = `intent-${row.basketItemId}`;

        h+=`
          <div class="buyerRow">
            <div>${row.buyerId}</div>
            <div>${row.requestedSets}</div>
            <div>
              <input class="qty"
                id="${inputId}"
                value="${row.intentSets}"
                ${locked?"disabled":""}>
            </div>
            <div>${row.approvedSets}</div>
            <div>
              <button ${locked?"disabled":""}
                onclick="saveIntent('${row.basketItemId}')">Save</button>
              <button ${locked?"disabled":""}
                onclick="approve('${row.basketItemId}')">Approve</button>
              <button class="reject" ${locked?"disabled":""}
                onclick="rejectItem('${row.basketItemId}')">Reject</button>
            </div>
          </div>
        `;
      });

      div.innerHTML=h+"</div>";
    });
}

/* ================= ACTIONS ================= */

function saveIntent(basketItemId){
  const v=document.getElementById(`intent-${basketItemId}`).value;

  fetch(`${API}?action=updateSupplierIntent&basketItemId=${basketItemId}&sets=${v}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){ alert(j.message); return; }
      load();
    });
}

function approve(basketItemId){
  if(!confirm("Approve this buyer for this product?")) return;

  fetch(`${API}?action=approveBasketItem&basketItemId=${basketItemId}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){ alert(j.message); return; }
      load();
    });
}

function rejectItem(basketItemId){
  if(!confirm("Reject buyer request?")) return;

  fetch(`${API}?action=rejectBasketItem&basketItemId=${basketItemId}`)
    .then(()=>load());
}
</script>

</body>
</html>
