function getSupplierActiveBatches(e){

  const supplier = String(e.parameter.supplierId||"").trim();
  const ss = db();

  const batches = ss.getSheetByName("Batches").getDataRange().getValues();
  const stock = ss.getSheetByName("Batch_Stock").getDataRange().getValues();
  const products = ss.getSheetByName("Products").getDataRange().getValues();
  const baskets = ss.getSheetByName("Baskets").getDataRange().getValues();
  const items = ss.getSheetByName("Basket_Items").getDataRange().getValues();

  /* product master */
  const pMap = {};
  products.forEach((p,i)=>{
    if(i>0 && p[1]===supplier){
      pMap[p[0]]={ name:p[2], physical:Number(p[10])||0 };
    }
  });

  /* which baskets are open */
  const openBaskets = {};
  baskets.forEach((b,i)=>{
    if(i>0 && b[3]==="OPEN"){
      openBaskets[b[0]] = true;
    }
  });

  /* aggregate buyer demand per batch+product */
  const demand = {}; // key=batch|product
  const approved = {};

  items.forEach((r,i)=>{
    if(i>0){
      const key = r[1]+"|"+r[2];
      demand[key] = (demand[key]||0) + (Number(r[3])||0);
      approved[key] = (approved[key]||0) + (Number(r[5])||0);
    }
  });

  const out = [];

  batches.forEach((b,i)=>{
    if(i>0 && b[1]===supplier && b[2]==="OPEN"){
      const batchId = b[0];
      const itemsOut = [];

      stock.forEach((s,j)=>{
        if(j>0 && s[0]===batchId){
          const code = s[1];
          const key = batchId+"|"+code;

          const total = Number(s[2])||0;
          const available = Number(s[4])||0;
          const req = demand[key]||0;
          const appr = approved[key]||0;
          const sellable = Math.max(available - req, 0);

          const p = pMap[code] || {};

          itemsOut.push({
            productCode:code,
            productName:p.name,
            physical:p.physical,
            totalSets:total,
            approvedSets:appr,
            requestedSets:req,
            availableSets:sellable
          });
        }
      });

      out.push({ batchId:batchId, items:itemsOut });
    }
  });

  return output({status:"success", data:out});
}
