<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Supplier – Active Batches</title>

<style>
body{font-family:Arial;background:#f4f5f7;margin:0}
header{
  background:#fff;
  padding:14px 18px;
  font-size:18px;
  font-weight:600;
  border-bottom:1px solid #ddd
}

.batch{
  background:#fff;
  margin:14px;
  border-radius:8px;
  border:1px solid #ddd
}
.batch h3{
  margin:0;
  padding:12px 16px;
  background:#fafafa;
  border-bottom:1px solid #eee
}

.row{
  display:grid;
  grid-template-columns:2fr 90px 90px 120px 120px;
  padding:10px 16px;
  border-top:1px solid #eee;
  font-size:13px;
  align-items:center
}
.row.head{
  font-weight:bold;
  background:#f9f9f9
}

.buyerBox{
  background:#fafafa;
  margin:6px 16px 12px;
  border:1px solid #ddd;
  border-radius:6px
}
.buyerRow{
  display:grid;
  grid-template-columns:120px 90px 90px 90px 200px;
  padding:6px 10px;
  font-size:12px;
  border-top:1px solid #eee;
  align-items:center
}
.buyerRow.head{
  font-weight:bold;
  background:#eee
}

input.qty{
  width:60px;
  padding:4px
}
button{
  padding:4px 8px;
  background:#000;
  color:#fff;
  border:none;
  cursor:pointer;
  margin-right:4px
}
button.reject{
  background:#c0392b
}
input[disabled],
button[disabled]{
  background:#aaa;
  cursor:not-allowed;
  opacity:0.6
}
</style>
</head>

<body>

<header>Active Batches – Supplier Control</header>
<div id="batches">Loading…</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzmemqtHqusZH8IClo9QWFM0RGks6qEzBd10aUP44XU-ImZo146DCmP1n4v1cevjFyr/exec";

let supplierId = localStorage.getItem("supplierId") || prompt("Enter Supplier ID");
localStorage.setItem("supplierId", supplierId);

/* ================= LOAD ================= */

function load(){
  fetch(`${API}?action=getSupplierActiveBatches&supplierId=${encodeURIComponent(supplierId)}`)
  .then(r=>r.json())
  .then(j=>{
    if(j.status !== "success"){
      document.getElementById("batches").innerText = j.message || "Failed to load";
      return;
    }
    render(j.data || []);
  })
  .catch(()=>{
    document.getElementById("batches").innerText = "Network error";
  });
}

load();

/* ================= RENDER ================= */

function render(batches){
  const wrap = document.getElementById("batches");
  wrap.innerHTML = "";

  if(!batches.length){
    wrap.innerHTML = "<small>No active batches</small>";
    return;
  }

  batches.forEach(b=>{
    const block = document.createElement("div");
    block.className = "batch";

    block.innerHTML = `
      <h3>Batch ${b.batchId}</h3>
      <div class="row head">
        <div>Product</div>
        <div>Batch</div>
        <div>Approved</div>
        <div>Requested</div>
        <div>Sellable</div>
      </div>
    `;

    (b.items || []).forEach(i=>{
      block.innerHTML += `
        <div class="row">
          <div><b>${i.productCode}</b><br>${i.productName || ""}</div>
          <div>${i.totalSets || 0}</div>
          <div>${i.approvedSets || 0}</div>
          <div>${i.requestedSets || 0}</div>
          <div><b>${i.availableSets || 0}</b></div>
        </div>
        <div id="buyers-${b.batchId}-${i.productCode}"></div>
      `;
      loadBuyers(b.batchId, i.productCode);
    });

    wrap.appendChild(block);
  });
}

/* ================= BUYER ROWS ================= */

function loadBuyers(batchId, productCode){
  fetch(`${API}?action=getBuyerRequestsForBatchProduct`
    + `&batchId=${encodeURIComponent(batchId)}`
    + `&productCode=${encodeURIComponent(productCode)}`)
  .then(r=>r.json())
  .then(j=>{
    if(j.status !== "success") return;

    const div = document.getElementById(`buyers-${batchId}-${productCode}`);
    if(!div || !j.data || !j.data.length){
      div.innerHTML = "";
      return;
    }

    let h = `
      <div class="buyerBox">
        <div class="buyerRow head">
          <div>Buyer</div>
          <div>Requested</div>
          <div>Intent</div>
          <div>Approved</div>
          <div>Action</div>
        </div>
    `;

    j.data.forEach(b=>{
      const isLocked =
        Number(b.approvedSets) > 0 ||
        b.status !== "OPEN";

      const disabled = isLocked ? "disabled" : "";

      h += `
        <div class="buyerRow">
          <div>${b.buyerId}</div>
          <div>${b.requestedSets}</div>
          <div>
            <input class="qty"
              id="i-${b.basketId}-${productCode}"
              value="${b.intentSets}"
              ${disabled}>
          </div>
          <div>${b.approvedSets}</div>
          <div>
            <button ${disabled}
              onclick="saveIntent('${b.basketId}','${productCode}')">
              Save
            </button>
            <button ${disabled}
              onclick="approve('${b.basketId}','${batchId}','${productCode}')">
              Approve
            </button>
            <button class="reject" ${disabled}
              onclick="reject('${b.basketId}','${batchId}','${productCode}')">
              Reject
            </button>
          </div>
        </div>
      `;
    });

    div.innerHTML = h + "</div>";
  });
}

/* ================= ACTIONS ================= */

function saveIntent(basketId, productCode){
  const v = document.getElementById(`i-${basketId}-${productCode}`).value;

  fetch(`${API}?action=updateSupplierIntent`
    + `&basketId=${encodeURIComponent(basketId)}`
    + `&productCode=${encodeURIComponent(productCode)}`
    + `&sets=${encodeURIComponent(v)}`)
  .then(r=>r.json())
  .then(j=>{
    if(j.status !== "success"){
      alert(j.message);
      return;
    }
    load();
  });
}

function approve(basketId, batchId, productCode){
  if(!confirm("Approve this buyer for this product?")) return;

  fetch(`${API}?action=approveBasketItem`
    + `&basketId=${encodeURIComponent(basketId)}`
    + `&batchId=${encodeURIComponent(batchId)}`
    + `&productCode=${encodeURIComponent(productCode)}`)
  .then(r=>r.json())
  .then(j=>{
    if(j.status !== "success"){
      alert(j.message);
      return;
    }
    load();
  });
}

function reject(basketId, batchId, productCode){
  if(!confirm("Reject buyer request?")) return;

  fetch(`${API}?action=rejectBasketItem`
    + `&basketId=${encodeURIComponent(basketId)}`
    + `&batchId=${encodeURIComponent(batchId)}`
    + `&productCode=${encodeURIComponent(productCode)}`)
  .then(()=>load());
}
</script>

</body>
</html>
